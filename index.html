<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <meta property="og:image" content="./img/title.jpg">
    <!-- <link rel="stylesheet" type="text/css" href="css/semantic.css">
    <link rel="stylesheet" type="text/css" href="css/template.css"> -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <!-- <script src="./rgbaster.min.js"></script> -->
	<!-- <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script> -->
    <style>
        *{
            margin:0;
            padding:0;
            list-style:none;
            text-decoration: none;
        }
        body{
            overflow-x:hidden;
            background-color:#fff;
        }
        ::-webkit-scrollbar { 
            display: none; 
        }
        .container{
            margin-top:50px;
            /* width:20000px; */
            /* width:auto; */
            /* width:100%; */
            /* overflow:hidden; */
            /* display:flex; */
            /* justify-content: space-around; */
            /* flex-wrap:nowrap; */
            /* justify-content: center; */
            /* align-items: stretch; */

            /* overflow-x: scroll; */
            white-space: nowrap;
        }
        .flexitem{
            /* float:left; */
            /* border:.5px solid #fff; */
            /* flex-shrink: 0; */
            /* flex-basis: 10px; */
            /* overflow:hidden; */
            position:absolute;
            left:0;
            top:0;
            box-shadow:none;
            z-index:0;
            margin:0;
            /* -webkit-box-shadow: 2px 4px 72px -20px rgba(0,0,0,0.77);
            -moz-box-shadow: 2px 4px 72px -20px rgba(0,0,0,0.77); */
        }
        .date{
            height:30px;
            overflow:visible !important;
        }
        .date span{
            font-size:16px;
        }
        .picture{
            width:100%;
            height:200px;
            overflow:hidden;
        }
        .picture img{
            /* left:-50%; */
            height:100%;
        }
        .Palette{
            /* position:absolute;
            bottom:0; */
            width:100%;
            height:100px;
            margin-top:3px;
            display:flex;
            flex-direction:column;
            /* background-color:#ddd; */
        }
        .Palette div{
            width:100%;
            height:100%
            /* height:20%; */
        }
        .pm25{
            height:150px;
            width:100%;
            /* margin:0 1px; */
            /* background-color:#ddd; */
            position:relative;
        }
        .pm25bar{
            width:100%;
            position:absolute;
            bottom:0;
            background-color:#888;
        }

        .baraxis{
            height:30px;
        }
    </style>
</head>
<body>
    <div class="container">
    </div>
<!-- <script src="rgb.js"></script> -->
<script src="./colorgram.js"></script>
<script>

    const datasize=365;
    const dataarray=Array.from(new Array(datasize),(val,index)=>index);
    const windowwidth=window.innerWidth;
    var margin = {top: 0, right: 0, bottom: 0, left: 0},
    width = window.innerWidth,
    height = 0;

    const parseDate = d3.timeParse("%Y-%m-%d");

    var x = d3.scaleBand()
          .range([0, width])
          .padding(0);
    // const timeformat = d3.timeFormat();    
    d3.csv("data.csv", type, function(error, data) {
      if (error) throw error;

        const container=d3.select('.container')
        .call(zoom);

        x.domain(data.map(function(d) { return d.date; }));
        console.log(x.bandwidth()); 
        console.log(x.step()); 
     console.log(windowwidth/datasize);
        container.selectAll('div')
            .data(data)
            .enter()
            .append('div')
            .attr('class','flexitem')
            .style('transform', function(d){
            return 'translateX('+x(d.date)+'px)'
            })
            .style("width", x.bandwidth()+'px')
            // .style('width',windowwidth/datasize+'px')
            // .on('click',function(d,i){
            //     d3.selectAll('.flexitem')
            //     .transition().duration(700)
            //         .style('width','30px')
            //     d3.select(this)
            //         .transition().duration(1000)
            //         .style('width','300px')
            //         .style('z-index','999')
            //         // .style('margin','0 8px')
            //         // .style('box-shadow', '2px 4px 72px -20px rgba(0,0,0,0.77)'  
            // });


        
        const flexitem=d3.selectAll('.flexitem');
    
        flexitem.append('div')
            .attr('class','date')
            .html(function(d,i){
                if(i==10||i==20||i==30||i==150)
                return d.date;
            });
        
        const picture=flexitem.append('div')
            .attr('class',function(d){
                return 'picture';
            })    
    
        picture.append('img')
            .attr('src',function(d,i){
            return 'image/img'+(i+1)+'.png';
                // return 'sky.jpg'
            })

        flexitem.append('div')
            .attr('class','Palette')
            .attr('id',function(d,i){
                return 'palette'+i;
            })

        const bar=flexitem.append('div')
            .attr('class','pm25')
            .attr('id',function(d,i){
                return 'pm25'+i;
            })
        bar.append('div')
            .attr('class','pm25bar')
            .attr('id',function(d,i){
                return 'pm25bar'+i;
            })
        d3.selectAll('.pm25bar')
            .style('height',function(d){
                return d.pm25+'px';
            });

        flexitem.append('div')
            .attr('class','baraxis')
            .html(function(d,i){
                if(i%30==1)
                return d.date;
            });
    });

    function zoom(svg) {
        const extent = [[margin.left, margin.top], [width - margin.right, height - margin.top]];
        
        svg.call(d3.zoom()
            .scaleExtent([1, 100])
            .translateExtent(extent)
            .extent(extent)
            .on("zoom", zoomed));
        
        function zoomed() {
            x.range([0,width].map(d => d3.event.transform.applyX(d)));
            svg.selectAll(".flexitem")
            .style('transform', function(d){
            return 'translateX('+x(d.date)+'px)'
            })
            .style("width", (x.bandwidth())+'px');

            console.log(x.bandwidth()); 
        console.log(x.step()); 
            // svg.selectAll(".x-axis").call(xAxis);
        }
        }



    function type(d) {
    //   d.date = parseDate(d.date);
        d.date = d.date;
        d.pm25 = +d.pm25;
        return d;
    }

//초반엔 조금씩 커지고 ++3 후반엔 ++20되는// pow..
    // const firstwidth=windowwidth/datasize;
    // const container=document.getElementsByClassName("container");

    // container[0].addEventListener("wheel", function(e) {
    //     let itemwidth=$('.flexitem').width();
    //     console.log(itemwidth);
    // let dir = Math.sign(e.deltaY);
    // if(dir===-1){
    //     itemwidth=itemwidth-10;
    //     if(itemwidth<firstwidth){itemwidth=firstwidth;}//처음위드보다 작으면 처음으로 두기이프문걸기
    //     d3.selectAll('.flexitem')
    //     .style('width',itemwidth+'px')
    // }
    // else{
    //     //그 최대위드보다 크면 안커지게 이프문걸기
    //     itemwidth=itemwidth+10;
    //     if(itemwidth>500){itemwidth=500;}
    //     d3.selectAll('.flexitem')
    //     .style('width',itemwidth+'px')
    // }
    // });

    //////////////////////////////////////
    //어차피 365개 가는거면 걍 헥사다 받아놓고 한방에 띄워도 될듯

    const colorwidth=200;
    const colorheight = 200;
    //그냥 폴더 따로 두는게 낫겟다..
    // var out=[48,55,78,93,94,166,167,190,191,192,193,209,353,354,28,29,44,53,63,67,108];
    const images=[];
    for(i=1;i<366;i++){
        
        // if(out.includes(i)){
        //     images.push('out.png');
        // }else{
            images.push('image/img'+i+'.png');
        // }
        // images.push('sky.jpg');
    }
    
	window.onload = function () {
		for (let i = 0; i < images.length; i++) {
			(function (i) {
				setTimeout(function () {
					processImage(images[i],false);
				}, i * 50);
			})(i);
		}
	};

	function loadImage(path, done) {
		let img = new Image();
		img.onload = function () {
	        const canvas = document.createElement('canvas');
			canvas.width = colorwidth;
            canvas.height = colorwidth * (img.height / img.width);
			const ctx = canvas.getContext('2d');
			ctx.drawImage(img, 0, 0, colorwidth, canvas.height);
			const id = ctx.getImageData(0, 0, canvas.width, canvas.height*0.4);
			done({width: canvas.width, height: canvas.height, data: id.data, channels: 4, canvas: canvas});
		};
		img.src = path;
    } 
    let count=-1;
    const palettedata=[0];
	function processImage(imagePath, prepend) {
		loadImage(imagePath, function (img) {
            count++;
            const stats = Colorgram.extract(img);
            // console.log(stats);

            d3.select('#palette'+count)
                .selectAll('div')
                .data(palettedata)
                .enter()
                .append('div')
                // .style('height',function(d){
                //     return stats[d][3]*100+'%';
                // })
                .style('background-color',function(d){
                        return 'rgb('+stats[d][0]+','+stats[d][1]+','+stats[d][2]+')';
                });
    })
	}
</script>
</body>
</html>